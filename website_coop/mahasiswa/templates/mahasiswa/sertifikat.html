{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sertifikat - COOP Portal</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>

<body style="background-color: #f4f7fe">

    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="sidebar-profile">
          <div class="avatar">{{ user.first_name|first }}</div>
          <div class="profile-info">
            <strong>{{ user.first_name }} {{ user.last_name }}</strong>
            <small>{{ profile.nim }}</small>
          </div>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li class="active">
              <a href="{% url 'mahasiswa:dashboard' %}"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
            </li>
            <li>
              <a href="{% url 'mahasiswa:profil' %}"><i class="bi bi-person-fill"></i> Profil</a>
            </li>
            <li>
              <a href="#"><i class="bi bi-bell-fill"></i> Notifikasi</a>
            </li>
            <li>
              <a href="#"><i class="bi bi-patch-check-fill"></i> Sertifikat</a>
            </li>
          </ul>
        </nav>
        <div class="sidebar-logout">
          <a href="#" class="btn btn-outline-dark">Logout</a>
        </div>
      </aside>

        <main class="main-dashboard-content">
            <section class="dashboard-header">
                <h2>Sertifikat Program COOP</h2>
                <p>Lihat dan unduh sertifikat Anda setelah program selesai.</p>
            </section>

            {% if magang and magang.status == 'Selesai' %}
                <div class="sertifikat-wrapper">
                    <div id="certificateToPrint" class="certificate">
                        <div class="cert-header">
                            <img src="https://www.prasetiyamulya.ac.id/wp-content/uploads/2020/01/Logo-Universitas-Prasetiya-Mulya.png" alt="Logo Prasmul">
                            <h1>SERTIFIKAT PENYELESAIAN</h1>
                            <p>CERTIFICATE OF COMPLETION</p>
                        </div>
                        <div class="cert-body">
                            <p class="given-to">Dengan ini menyatakan bahwa:</p>
                            <h2 class="student-name">{{ user.get_full_name }}</h2>
                            <p class="nim">NIM: {{ user.mahasiswa.nim }}</p>
                            <p class="completion-text">
                                Telah berhasil menyelesaikan program Co-operative Education (COOP)
                                pada program studi <strong>{{ user.mahasiswa.program_studi }}</strong>
                                dengan rincian sebagai berikut:
                            </p>
                            <table class="cert-details-table">
                                <tr><td>Perusahaan</td><td>: {{ magang.nama_perusahaan }}</td></tr>
                                <tr><td>Posisi</td><td>: {{ magang.posisi }}</td></tr>
                                <tr><td>Periode Magang</td><td>: {{ magang.periode_magang }}</td></tr>
                                <tr><td>Konversi Nilai</td><td>: <strong>{{ magang.nilai_akhir }}</strong></td></tr>
                            </table>
                        </div>
                        <div class="cert-footer">
                            <p>Tangerang, {% now "j F Y" %}</p>
                            <div class="signature">
                                <p><strong>Nama Rektor</strong></p>
                                <p>Rektor Universitas Prasetiya Mulya</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="downloadBtn" class="btn btn-primary download-btn mt-4">
                        <i class="bi bi-download"></i> Unduh sebagai PDF
                    </button>
                </div>
            
            {% else %}
                <div class="card-item text-center">
                    <h3 class="sertifikat-title">Program Belum Selesai</h3>
                    <p>Halaman ini akan menampilkan sertifikat Anda setelah program COOP dinyatakan selesai.</p>
                    <i class="bi bi-hourglass-split" style="font-size: 60px; color: #ccc; margin-top: 20px;"></i>
                </div>
            {% endif %}
            </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script>
        // Pastikan tombol download hanya berfungsi jika ada
        const downloadButton = document.getElementById('downloadBtn');
        if (downloadButton) {
            downloadButton.addEventListener('click', function () {
                const element = document.getElementById('certificateToPrint');
                const opt = {
                    margin:       0.5,
                    filename:     'Sertifikat_COOP_{{ user.first_name }}_{{ user.mahasiswa.nim }}.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
                };
                html2pdf().from(element).set(opt).save();
            });
        }
    </script>

</body>
</html>